class PolyStorage{static async get(e,t=null){return new Promise((a=>{if("undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local)chrome.storage.local.get([e],(o=>{a(void 0!==o[e]?o[e]:t)}));else{const o=localStorage.getItem(e);a(o?JSON.parse(o):t)}}))}static async set(e,t){return new Promise((a=>{"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.set({[e]:t},(()=>{a(!0)})):(localStorage.setItem(e,JSON.stringify(t)),a(!0))}))}static async remove(e){return new Promise((t=>{"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.remove([e],(()=>{t(!0)})):(localStorage.removeItem(e),t(!0))}))}}class PolySettings{static STORAGE_KEY="poly_metrics_settings";static defaultSettings={defaultTax:20,defaultCurrency:"VND",toggleState:"closed",currencies:[{code:"USD",name:"US Dollar",symbol:"$",rate:1},{code:"VND",name:"Vietnamese Dong",symbol:"‚Ç´",rate:23e3},{code:"EUR",name:"Euro",symbol:"‚Ç¨",rate:.92},{code:"GBP",name:"British Pound",symbol:"¬£",rate:.79},{code:"JPY",name:"Japanese Yen",symbol:"¬•",rate:149.5},{code:"CNY",name:"Chinese Yuan",symbol:"¬•",rate:7.24},{code:"INR",name:"Indian Rupee",symbol:"‚Çπ",rate:83.12},{code:"BRL",name:"Brazilian Real",symbol:"R$",rate:4.97},{code:"AUD",name:"Australian Dollar",symbol:"A$",rate:1.53},{code:"CAD",name:"Canadian Dollar",symbol:"C$",rate:1.38},{code:"CHF",name:"Swiss Franc",symbol:"CHF",rate:.88},{code:"SGD",name:"Singapore Dollar",symbol:"S$",rate:1.34},{code:"HKD",name:"Hong Kong Dollar",symbol:"HK$",rate:7.83},{code:"KRW",name:"South Korean Won",symbol:"‚Ç©",rate:1320.5},{code:"MXN",name:"Mexican Peso",symbol:"Mex$",rate:17.15},{code:"RUB",name:"Russian Ruble",symbol:"‚ÇΩ",rate:92.5},{code:"THB",name:"Thai Baht",symbol:"‡∏ø",rate:34.85}]};static async load(){const e=await PolyStorage.get(this.STORAGE_KEY,this.defaultSettings);return{...this.defaultSettings,...e}}static async save(e){return await PolyStorage.set(this.STORAGE_KEY,e)}}class BookmarkManager{static BOOKMARKS_KEY="poly_bookmarks";static CATEGORIES_KEY="poly_bookmark_categories";static generateId(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}static getDefaultCategories(){return[{id:this.generateId(),name:"Uncategorized",color:"#6c757d"},{id:this.generateId(),name:"My Favorites",color:"#ffc107"},{id:this.generateId(),name:"To Review",color:"#17a2b8"},{id:this.generateId(),name:"Competitors",color:"#dc3545"}]}static async getCategories(){let e=await PolyStorage.get(this.CATEGORIES_KEY,null);return e&&0!==e.length||(e=this.getDefaultCategories(),await PolyStorage.set(this.CATEGORIES_KEY,e)),e}static async getCategory(e){const t=await this.getCategories();return t.find((t=>t.id===e))||t[0]}static async addCategory(e,t="#6c757d"){const a=await this.getCategories(),o={id:this.generateId(),name:e,color:t};return a.push(o),await PolyStorage.set(this.CATEGORIES_KEY,a),o}static async updateCategory(e,t,a){const o=await this.getCategories(),n=o.findIndex((t=>t.id===e));return n>=0?(o[n].name=t,o[n].color=a,await PolyStorage.set(this.CATEGORIES_KEY,o),o[n]):null}static async deleteCategory(e){const t=(await this.getCategories()).filter((t=>t.id!==e));if(t.length>0){const a=t[0].id,o=await this.getBookmarks();o.forEach((t=>{t.categoryId===e&&(t.categoryId=a)})),await PolyStorage.set(this.BOOKMARKS_KEY,o)}return await PolyStorage.set(this.CATEGORIES_KEY,t),!0}static async getBookmarks(){return await PolyStorage.get(this.BOOKMARKS_KEY,[])}static async getBookmarksByCategory(e){return(await this.getBookmarks()).filter((t=>t.categoryId===e))}static async getBookmark(e){return(await this.getBookmarks()).find((t=>t.id===e))}static async addBookmark(e,t,a){const o=await this.getBookmarks(),n={id:this.generateId(),title:e,url:t,categoryId:a,createdAt:(new Date).toISOString()};return o.push(n),await PolyStorage.set(this.BOOKMARKS_KEY,o),n}static async updateBookmark(e,t,a,o){const n=await this.getBookmarks(),s=n.findIndex((t=>t.id===e));return s>=0?(n[s].title=t,n[s].url=a,n[s].categoryId=o,n[s].updatedAt=(new Date).toISOString(),await PolyStorage.set(this.BOOKMARKS_KEY,n),n[s]):null}static async deleteBookmark(e){const t=(await this.getBookmarks()).filter((t=>t.id!==e));return await PolyStorage.set(this.BOOKMARKS_KEY,t),!0}}function switchTab(e){document.querySelectorAll(".poly-tab-btn").forEach((e=>e.classList.remove("active")));const t=document.querySelector(`.poly-tab-btn[data-tab="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".poly-tab-panel").forEach((e=>e.classList.remove("active")));const a=document.getElementById(`tab-${e}`);a&&a.classList.add("active")}async function loadSettings(){const e=await PolySettings.load();document.getElementById("settings-tax").value=e.defaultTax||20;const t=document.getElementById("settings-currency");t.innerHTML="",e.currencies.forEach((a=>{const o=document.createElement("option");o.value=a.code,o.textContent=`${a.code} (${a.symbol})`,a.code===e.defaultCurrency&&(o.selected=!0),t.appendChild(o)})),renderCurrenciesTable(e.currencies)}function renderCurrenciesTable(e){const t=document.getElementById("currencies-list");t.innerHTML="",e.forEach(((e,a)=>{const o=document.createElement("tr");o.innerHTML=`\n            <td><input type="text" class="currency-code" value="${e.code}" ${a<2?"readonly":""}></td>\n            <td><input type="text" class="currency-name" value="${e.name}"></td>\n            <td><input type="text" class="currency-symbol" value="${e.symbol}"></td>\n            <td><input type="number" class="currency-rate" value="${e.rate}" step="0.01"></td>\n            <td>${a<2?'<span style="color:#999">Protected</span>':'<button class="poly-btn-remove" data-index="'+a+'">‚úï</button>'}</td>\n        `,t.appendChild(o)}))}function setupEventHandlers(){document.getElementById("add-currency-btn").addEventListener("click",(()=>{const e=document.getElementById("currencies-list"),t=document.createElement("tr");t.innerHTML='\n            <td><input type="text" class="currency-code" value="" placeholder="CODE"></td>\n            <td><input type="text" class="currency-name" value="" placeholder="Currency Name"></td>\n            <td><input type="text" class="currency-symbol" value="" placeholder="$"></td>\n            <td><input type="number" class="currency-rate" value="1" step="0.01"></td>\n            <td><button class="poly-btn-remove-new">‚úï</button></td>\n        ',e.appendChild(t)})),document.addEventListener("click",(e=>{(e.target.classList.contains("poly-btn-remove")||e.target.classList.contains("poly-btn-remove-new"))&&confirm("Remove this currency?")&&e.target.closest("tr").remove()})),document.addEventListener("input",(e=>{if(e.target.classList.contains("currency-rate")||"settings-tax"===e.target.id){let t=e.target.value;t=t.replace(/[^\d.]/g,"");const a=t.split(".");a.length>2&&(t=a[0]+"."+a.slice(1).join("")),e.target.value=t}})),document.getElementById("save-settings-btn").addEventListener("click",(async()=>{const e=await PolySettings.load();e.defaultTax=parseInt(document.getElementById("settings-tax").value)||20,e.defaultTax<0&&(e.defaultTax=0),e.defaultTax>100&&(e.defaultTax=100),e.defaultCurrency=document.getElementById("settings-currency").value;const t=[];document.querySelectorAll("#currencies-list tr").forEach((e=>{const a=e.querySelector(".currency-code").value.trim().toUpperCase(),o=e.querySelector(".currency-name").value.trim(),n=e.querySelector(".currency-symbol").value.trim();let s=parseFloat(e.querySelector(".currency-rate").value);(isNaN(s)||s<=0)&&(s=1),a&&o&&n&&t.push({code:a,name:o,symbol:n,rate:s})})),t.length>0?(e.currencies=t,await PolySettings.save(e),showNotification("Settings saved successfully!","success")):showNotification("Please add at least one currency!","error")})),document.getElementById("reset-settings-btn").addEventListener("click",(async()=>{confirm("Reset all settings to default? This will remove all custom currencies and settings.")&&(await PolyStorage.remove(PolySettings.STORAGE_KEY),showNotification("Settings reset successfully!","success"),setTimeout((()=>{location.reload()}),1e3))}))}function showNotification(e,t="info"){const a=document.createElement("div");a.className=`poly-notification poly-notification-${t}`,a.textContent=e,document.body.appendChild(a),setTimeout((()=>{a.classList.add("show")}),10),setTimeout((()=>{a.classList.remove("show"),setTimeout((()=>{a.remove()}),300)}),3e3)}async function loadBookmarks(){await renderCategories(),await renderBookmarks()}async function renderCategories(){const e=await BookmarkManager.getCategories(),t=document.getElementById("bookmark-categories-list"),a=document.getElementById("bookmark-filter-category");t.innerHTML="";for(const a of e){const e=(await BookmarkManager.getBookmarksByCategory(a.id)).length,o=document.createElement("div");o.className="poly-category-card",o.innerHTML=`\n            <div class="poly-category-header">\n                <div class="poly-category-name">\n                    <span class="poly-category-color-dot" style="background-color: ${a.color}"></span>\n                    <span>${a.name}</span>\n                </div>\n                <div class="poly-category-actions">\n                    <button class="poly-btn-icon" data-action="edit" data-id="${a.id}" title="Edit">‚úèÔ∏è</button>\n                    <button class="poly-btn-icon" data-action="delete" data-id="${a.id}" title="Delete">üóëÔ∏è</button>\n                </div>\n            </div>\n            <div class="poly-category-count">${e} bookmark${1!==e?"s":""}</div>\n        `,t.appendChild(o)}a.innerHTML='<option value="">All Categories</option>',e.forEach((e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,t.style.color=e.color,a.appendChild(t)}))}async function renderBookmarks(e="",t=""){let a=await BookmarkManager.getBookmarks();const o=await BookmarkManager.getCategories();if(e&&(a=a.filter((t=>t.categoryId===e))),t){const e=t.toLowerCase();a=a.filter((t=>t.title.toLowerCase().includes(e)||t.url.toLowerCase().includes(e)))}const n=document.getElementById("bookmarks-list");0!==a.length?(n.innerHTML="",a.forEach((e=>{const t=o.find((t=>t.id===e.categoryId))||o[0],a=document.createElement("div");a.className="poly-bookmark-card",a.innerHTML=`\n            <div class="poly-bookmark-info">\n                <div class="poly-bookmark-title">${e.title}</div>\n                <div class="poly-bookmark-meta">\n                    <span class="poly-bookmark-category-label">\n                        <span class="poly-category-color-dot" style="background-color: ${t.color}"></span>\n                        ${t.name}\n                    </span>\n                    <a href="${e.url}" target="_blank" class="poly-bookmark-url">${e.url}</a>\n                </div>\n            </div>\n            <div class="poly-bookmark-actions">\n                <button class="poly-btn poly-btn-sm poly-btn-secondary" data-action="edit" data-id="${e.id}">‚úèÔ∏è Edit</button>\n                <button class="poly-btn poly-btn-sm poly-btn-secondary" data-action="visit" data-url="${e.url}">üîó Visit</button>\n                <button class="poly-btn poly-btn-sm poly-btn-danger" data-action="delete" data-id="${e.id}">üóëÔ∏è Delete</button>\n            </div>\n        `,n.appendChild(a)}))):n.innerHTML='\n            <div class="poly-bookmarks-empty">\n                <div class="poly-bookmarks-empty-icon">üìë</div>\n                <div class="poly-bookmarks-empty-text">No bookmarks found</div>\n                <div class="poly-bookmarks-empty-hint">Visit product pages and click the bookmark icon next to the title to save bookmarks</div>\n            </div>\n        '}function setupBookmarkHandlers(){document.addEventListener("click",(e=>{e.target&&"add-bookmark-category-btn"===e.target.id&&(e.preventDefault(),showCategoryModal())}));const e=document.getElementById("bookmark-categories-list");e&&e.addEventListener("click",(async e=>{const t=e.target.closest(".poly-btn-icon");if(!t)return;const a=t.dataset.action,o=t.dataset.id;if("edit"===a){showCategoryModal(await BookmarkManager.getCategory(o))}else"delete"===a&&confirm("Delete this category? Bookmarks will be moved to Uncategorized.")&&(await BookmarkManager.deleteCategory(o),showNotification("Category deleted successfully!","success"),await loadBookmarks())}));const t=document.getElementById("bookmarks-list");t&&t.addEventListener("click",(async e=>{const t=e.target.closest("button[data-action]");if(!t)return;const a=t.dataset.action;if("visit"===a){const e=t.dataset.url;window.open(e,"_blank")}else if("edit"===a){const e=t.dataset.id;showBookmarkModal(await BookmarkManager.getBookmark(e))}else if("delete"===a){const e=t.dataset.id;confirm("Delete this bookmark?")&&(await BookmarkManager.deleteBookmark(e),showNotification("Bookmark deleted successfully!","success"),await loadBookmarks())}}));const a=document.getElementById("bookmark-filter-category");a&&a.addEventListener("change",(async e=>{const t=e.target.value,a=document.getElementById("bookmark-search").value;await renderBookmarks(t,a)}));const o=document.getElementById("bookmark-search");o&&o.addEventListener("input",(async e=>{const t=e.target.value,a=document.getElementById("bookmark-filter-category").value;await renderBookmarks(a,t)}))}function showCategoryModal(e=null){const t=null!==e,a="category-modal";document.getElementById(a)?.remove();const o=document.createElement("div");o.id=a,o.className="poly-modal poly-modal-small poly-modal-show",o.innerHTML=`\n        <div class="poly-modal-content">\n            <div class="poly-modal-header">\n                <h3>${t?"Edit":"Add"} Category</h3>\n                <span class="poly-modal-close">&times;</span>\n            </div>\n            <div class="poly-modal-body">\n                <div class="poly-category-form">\n                    <div class="poly-settings-group">\n                        <label class="poly-settings-label">Category Name</label>\n                        <input type="text" id="category-name" class="poly-settings-input" value="${t?e.name:""}" placeholder="e.g. My Favorites">\n                    </div>\n                    <div class="poly-settings-group">\n                        <label class="poly-settings-label">Color</label>\n                        <input type="color" id="category-color" class="poly-input-color-picker" value="${t?e.color:"#6c757d"}">\n                    </div>\n                </div>\n            </div>\n            <div class="poly-modal-footer">\n                <button id="save-category-btn" class="poly-btn poly-btn-primary">${t?"Update":"Add"} Category</button>\n                <button class="poly-btn poly-btn-secondary poly-modal-close">Cancel</button>\n            </div>\n        </div>\n    `,document.body.appendChild(o),document.getElementById("save-category-btn").addEventListener("click",(async()=>{const a=document.getElementById("category-name").value.trim(),n=document.getElementById("category-color").value;a?(t?(await BookmarkManager.updateCategory(e.id,a,n),showNotification("Category updated successfully!","success")):(await BookmarkManager.addCategory(a,n),showNotification("Category added successfully!","success")),o.remove(),await loadBookmarks()):showNotification("Please enter a category name","error")})),o.querySelectorAll(".poly-modal-close").forEach((e=>{e.addEventListener("click",(()=>o.remove()))})),o.addEventListener("click",(e=>{e.target===o&&o.remove()}))}function showBookmarkModal(e=null){const t=null!==e,a="bookmark-edit-modal";document.getElementById(a)?.remove(),BookmarkManager.getCategories().then((o=>{const n=document.createElement("div");n.id=a,n.className="poly-modal poly-modal-small poly-modal-show";let s="";o.forEach((a=>{const o=t&&e.categoryId===a.id?"selected":"";s+=`<option value="${a.id}" ${o} style="color: ${a.color}">${a.name}</option>`})),n.innerHTML=`\n            <div class="poly-modal-content">\n                <div class="poly-modal-header">\n                    <h3>Edit Bookmark</h3>\n                    <span class="poly-modal-close">&times;</span>\n                </div>\n                <div class="poly-modal-body">\n                    <div class="poly-settings-group">\n                        <label class="poly-settings-label">Title</label>\n                        <input type="text" id="bookmark-edit-title" class="poly-settings-input" value="${t?e.title:""}">\n                    </div>\n                    <div class="poly-settings-group">\n                        <label class="poly-settings-label">URL</label>\n                        <input type="text" id="bookmark-edit-url" class="poly-settings-input" value="${t?e.url:""}">\n                    </div>\n                    <div class="poly-settings-group">\n                        <label class="poly-settings-label">Category</label>\n                        <select id="bookmark-edit-category" class="poly-settings-select">\n                            ${s}\n                        </select>\n                    </div>\n                </div>\n                <div class="poly-modal-footer">\n                    <button id="save-bookmark-edit-btn" class="poly-btn poly-btn-primary">Update Bookmark</button>\n                    <button class="poly-btn poly-btn-secondary poly-modal-close">Cancel</button>\n                </div>\n            </div>\n        `,document.body.appendChild(n),document.getElementById("save-bookmark-edit-btn").addEventListener("click",(async()=>{const t=document.getElementById("bookmark-edit-title").value.trim(),a=document.getElementById("bookmark-edit-url").value.trim(),o=document.getElementById("bookmark-edit-category").value;t&&a?(await BookmarkManager.updateBookmark(e.id,t,a,o),showNotification("Bookmark updated successfully!","success"),n.remove(),await loadBookmarks()):showNotification("Please enter title and URL","error")})),n.querySelectorAll(".poly-modal-close").forEach((e=>{e.addEventListener("click",(()=>n.remove()))})),n.addEventListener("click",(e=>{e.target===n&&n.remove()}))}))}document.addEventListener("DOMContentLoaded",(async()=>{const e=window.location.hash.replace("#","");e&&document.getElementById(`tab-${e}`)&&switchTab(e),document.querySelectorAll(".poly-tab-btn").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.tab;switchTab(t),window.location.hash=t}))})),await loadSettings(),await loadBookmarks(),setupEventHandlers(),setupBookmarkHandlers()}));